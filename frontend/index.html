<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pokedex</title>
    <link rel="stylesheet" href="./css/index.css">
</head>
<body>
    <section class="search-area">
        <form class="search-form">
            <input class="search-input" type="text" name="name" placeholder="pokemon name" height="30px">
            <div class="search-button">GO!</button>
        </form>
    </section>
    <section class="display-area">
        <div class="card">
            <!-- BIG CARD CREATED DINAMICALLY HERE -->
        </div>
        <ol id="card-deck">
            <!-- DECK OF SMALL CARDS CREATED DINAMICALLY HERE -->
        </ol>
    </section>

    <script>
        let range = 50;
        let startingPokemon = 1;
        const card = document.querySelector(".card");
        const pokeForm = document.querySelector(".search-form input");
        const titleInput = document.querySelector(".dex-title");
        const typesInput = document.querySelector(".dex-types");
        const spriteInput = document.querySelector(".dex-sprite");
        const cardDeck = document.querySelector("#card-deck");
        const button = document.querySelector(".search-button");
        const missingno = {
            id: 0,
            name: "missingno",
            icon: "./assets/icons/unknown.png",
            sprite: "./assets/missingno.png",
            types: ["unknown"]
        }
        const colorType = {
            normal: "A8A77A",
            fire: "EE8130",
            water: "6390F0",
            electric: "F7D02C",
            grass: "7AC74C",
            ice: "96D9D6",
            fighting: "C22E28",
            poison: "A33EA1",
            ground: "E2BF65",
            flying: "A98FF3",
            psychic: "F95587",
            bug: "A6B91A",
            rock: "B6A136",
            ghost: "735797",
            dragon: "6F35FC",
            dark: "705746",
            steel: "B7B7CE",
            fairy: "D685AD",
            unknown: "000000"
        }
        let noThrottle = true;


        const createBigCard = (obj) => {
            // !!!!!!!! SEE CARD SCTRUCTURE BELOW !!!!!!!!
            /*
            <div class="card">

                <div class="content-container">
                    <div class="dex-title">
                        <!-- NAME -->
                    </div>
                    <div class="dex-types">
                        <!-- TYPE IMG(S) -->
                    </div>
                </div>
                <div class="dex-sprite">
                <!-- SPRITE -->
                </div>

            </div>
            */

            card.innerHTML = ""; //clear current card content

            let newContentContainer = document.createElement('div');
            let newDexTitle = document.createElement('div');
            let newDexTypes = document.createElement('div');
            let newDexSprite = document.createElement('div');
            
            
            newContentContainer.className = "content-container";
            newDexTitle.className = "dex-title";
            newDexTypes.className = "dex-types";
            newDexSprite.className = "dex-sprite";

            newDexTitle.innerHTML = obj.name;
            newContentContainer.appendChild(newDexTitle);

            let newSprite;
            for (let i = 0; i < obj.types.length ; i++) {
                newSprite = document.createElement('img');
                if (obj.types[i] === "unknown") { newSprite.src = "./assets/icons/unknown.png" }
                else { newSprite.src = `./assets/icons/${obj.types[i]}_en.png` }
                newSprite.style.height = '25px';
                newDexTypes.appendChild(newSprite);
            }
            newContentContainer.appendChild(newDexTypes);
            if ( obj.types.length > 1 ) {
                newContentContainer.style.backgroundColor = `#${colorType[obj.types[1]]}`;
                newContentContainer.style.boxShadow = "0px 1px 0px black";
            }
            card.appendChild(newContentContainer);

            newSprite = document.createElement('img');
            newSprite.src = `${obj.sprite}`;
            newSprite.style.height = "200px";
            newSprite.style.margin = "10px 20px 20px 20px";
            card.appendChild(newSprite);

            card.style.backgroundColor = `#${colorType[obj.types[0]]}`;
            card.style.display = "flex";
        }

        const createSmallCard = (obj) => {
            let newCardBody = document.createElement('li');
            let newCardTop = document.createElement('div');
            let newCardBottom = document.createElement('div');
            let cardSprite = document.createElement('img');
            let typeLine = document.createElement('div')
            
            newCardTop.className = "small-card-top";
            newCardBottom.className = "small-card-bottom";
            newCardBody.className = "small-card";
            newCardTop.innerHTML = `#${obj.id}`;
            cardSprite.className = "img";
            cardSprite.src = obj.sprite;
            typeLine.style.height = "5px";
            typeLine.style.backgroundImage = `linear-gradient(to right, #${colorType[obj.types[0]]} 50%, #${colorType[obj.types[obj.types.length-1]]} 50%`;
            
            newCardBody.appendChild(newCardTop);
            newCardBody.appendChild(typeLine);
            newCardBottom.appendChild(cardSprite);
            newCardBody.appendChild(newCardBottom);
            
            newCardBody.addEventListener("click", () => { createBigCard(obj) });

            return newCardBody;
        }

        async function getSingleCard (event) {
            event.preventDefault();
            let success = true;
            const pokemon = pokeForm.value.toLowerCase();
            await fetch(`http://localhost:5000/newsearch?name=${pokemon.replace(/\s/g, '-')}`)
            .then(res => res.json())
            .then(obj => {
                if (obj === "oops") {
                    console.log('Got an "oops" error from the backend ==> Load MISSIGNO')
                    createBigCard(missingno)
                }
                else { createBigCard(obj) }
            })
            card.style.display = "flex";
        }

        async function getDeckList (offset, range) {
            await fetch(`http://localhost:5000/carddeck?offset=${offset-1}&range=${range}`)
            .then(res => res.json())
            .then(obj => {  //recebe um array de novos pkms a serem adicionados ao deck
                if (obj != "oops"){
                    obj = obj[0];
                    obj.forEach( el => { cardDeck.appendChild( createSmallCard(el) ) })
                    let stackOfCards = document.querySelectorAll(".small-card");
                }
            })
        }


        getDeckList(1, range);  //ON PAGE LOAD => INITIAL DECK
        startingPokemon = startingPokemon + range;

        window.addEventListener("scroll", async () => {
            const {scrollTop, scrollHeight, clientHeight} = document.documentElement;
            if (noThrottle === true && scrollTop + 300 > scrollHeight - clientHeight) {
                noThrottle = false;
                await getDeckList(startingPokemon, range)
                .then(() => {
                    startingPokemon = startingPokemon + range;
                    noThrottle = true; //after finished with the current deck building, allow for new deck building requests
                })
            }
        })


        button.addEventListener("click", getSingleCard);

        // FORM CLICKER ==> HITTING ENTER WHILE TYPING A POKEMON WILL CLICK THE "GO!" BUTTON
        pokeForm.addEventListener("keydown", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                button.click();
                pokeForm.value="";
            }
        });
        </script>
    </body>
</html>